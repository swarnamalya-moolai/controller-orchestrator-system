<!-- controller/templates/dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Orchestrator Dashboard</title>
    <meta http-equiv="refresh" content="600"> <!-- Just in case, fallback refresh every 10 minutes -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container py-5">
        <h1 class="mb-4 text-center">Orchestrator Monitoring Dashboard</h1>

        <table class="table table-bordered table-hover bg-white">
            <thead class="table-dark">
                <tr>
                    <th>Orchestrator ID</th>
                    <th>IP Address</th>
                    <th>Last Seen</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="dashboard-body">
                <!-- dynamic data here -->
            </tbody>
        </table>
    </div>

    <!-- Toast Container -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 9999">
        <div id="toast-container"></div>
    </div>

    <script>
        let previousStatus = {};

        async function fetchStatus() {
            const response = await fetch('/api/heartbeat_status');
            const data = await response.json();

            const tbody = document.getElementById('dashboard-body');
            tbody.innerHTML = '';

            data.forEach(item => {
                const tr = document.createElement('tr');

                const statusClass = item.status === 'Online' ? 'bg-success' : 'bg-danger';
                tr.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.ip}</td>
                    <td>${item.last_seen}</td>
                    <td><span class="badge ${statusClass}">${item.status}</span></td>
                `;

                tbody.appendChild(tr);

                // Check for status change
                if (previousStatus[item.id] && previousStatus[item.id] !== item.status) {
                    showToast(item.id, item.status);
                }

                // Update previous status
                previousStatus[item.id] = item.status;
            });
        }

        function showToast(orchestratorId, status) {
            const toastId = `toast-${Date.now()}`;
            const toastHtml = `
                <div class="toast align-items-center text-white ${status === 'Offline' ? 'bg-danger' : 'bg-success'} border-0 mb-2" role="alert" id="${toastId}">
                    <div class="d-flex">
                        <div class="toast-body">
                            Orchestrator <strong>${orchestratorId}</strong> is now <strong>${status}</strong>.
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            const container = document.getElementById('toast-container');
            container.insertAdjacentHTML('beforeend', toastHtml);

            const toastEl = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastEl, { delay: 5000 });
            toast.show();

            // Optional: remove toast from DOM after it hides
            toastEl.addEventListener('hidden.bs.toast', () => {
                toastEl.remove();
            });
        }

        // Fetch every 10 seconds
        setInterval(fetchStatus, 10000);
        fetchStatus();
    </script>

    <!-- Bootstrap Toasts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
